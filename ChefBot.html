<!DOCTYPE html>
<html lang="pt">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ChefBot - Assistente Gastron√≥mico</title>
    <link
      rel="icon"
      href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üë®‚Äçüç≥</text></svg>"
    />
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
      body { font-family: 'Inter', sans-serif; }
      @keyframes fadeIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }
      .animate-fadeIn { animation: fadeIn 0.4s cubic-bezier(0.4, 0, 0.2, 1); }
      .sidebar { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
      .sidebar-hidden { transform: translateX(-100%); width: 0; overflow: hidden; }
      .custom-scrollbar::-webkit-scrollbar { width: 4px; }
      .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
      .custom-scrollbar::-webkit-scrollbar-thumb { background: #e2e8f0; border-radius: 10px; }
      .message-bubble { max-width: 85%; }
    </style>
  </head>
  <body class="h-screen overflow-hidden bg-[#F8FAFC]">
    <div id="app" class="flex h-screen text-slate-800"></div>

    <script>
      const RASA_URL = "http://localhost:5005/webhooks/rest/webhook";

      let messages = [{ type: "bot", text: "Ol√°! Sou o seu assistente ChefBot. Como posso ajudar na cozinha hoje? üë®‚Äçüç≥", timestamp: new Date() }];
      let isTyping = false;
      let input = "";
      let conversations = [];
      let currentConversationId = null;
      let viewingHistoryId = null;
      let sidebarOpen = true;

      const quickActions = [
        { text: "Quero cozinhar algo", icon: "üç≥", color: "bg-white border-slate-200 text-slate-700" },
        { text: "Mostrar favoritos", icon: "‚≠ê", color: "bg-white border-slate-200 text-slate-700" },
        { text: "Receitas recentes", icon: "üïí", color: "bg-white border-slate-200 text-slate-700" },
      ];

      function loadConversations() {
        const saved = localStorage.getItem("chefbot_conversations");
        if (saved) conversations = JSON.parse(saved);
      }

      function saveConversations() {
        localStorage.setItem("chefbot_conversations", JSON.stringify(conversations));
      }

      function createNewConversation() {
        viewingHistoryId = null;
        currentConversationId = Date.now().toString();
        messages = [{ type: "bot", text: "Ol√°! Sou o seu assistente ChefBot. Como posso ajudar na cozinha hoje? üë®‚Äçüç≥", timestamp: new Date() }];
        render();
      }

      function saveCurrentConversation() {
        if (!currentConversationId || messages.length <= 1 || viewingHistoryId) return;
        const existingIndex = conversations.findIndex((c) => c.id === currentConversationId);
        const conversationData = {
          id: currentConversationId,
          title: generateConversationTitle(),
          messages: messages,
          lastUpdate: new Date().toISOString(),
        };
        if (existingIndex >= 0) conversations[existingIndex] = conversationData;
        else conversations.unshift(conversationData);
        if (conversations.length > 50) conversations = conversations.slice(0, 50);
        saveConversations();
      }

      function generateConversationTitle() {
        const userMessages = messages.filter((m) => m.type === "user");
        if (userMessages.length > 0) {
          const firstMsg = userMessages[0].text;
          return firstMsg.length > 25 ? firstMsg.substring(0, 25) + "..." : firstMsg;
        }
        return "Nova Receita";
      }

      function loadConversation(id) {
        const conv = conversations.find((c) => c.id === id);
        if (conv) {
          viewingHistoryId = id;
          messages = conv.messages.map((m) => ({ ...m, timestamp: new Date(m.timestamp) }));
          render();
        }
      }

      function deleteConversation(id) {
        conversations = conversations.filter((c) => c.id !== id);
        saveConversations();
        if (viewingHistoryId === id) createNewConversation();
        else render();
      }

      function toggleSidebar() {
        sidebarOpen = !sidebarOpen;
        render();
      }

      function render() {
        const app = document.getElementById("app");
        const isViewingHistory = viewingHistoryId !== null;

        app.innerHTML = `
                <div class="sidebar ${sidebarOpen ? "w-72" : "sidebar-hidden"} bg-white border-r border-slate-200 flex flex-col z-20">
                    <div class="p-6">
                        <div class="flex items-center justify-between mb-6">
                            <span class="font-bold text-xl tracking-tight text-slate-900">Hist√≥rico</span>
                            <button onclick="toggleSidebar()" class="md:hidden text-slate-400">‚úï</button>
                        </div>
                        <button onclick="createNewConversation()" class="w-full bg-slate-900 hover:bg-slate-800 text-white py-2.5 px-4 rounded-xl transition-all flex items-center justify-center gap-2 text-sm font-medium shadow-sm">
                            <span class="text-lg">+</span> Nova Conversa
                        </button>
                    </div>

                    <div class="flex-1 overflow-y-auto px-3 custom-scrollbar">
                        ${conversations.length === 0 ? `
                            <div class="text-center py-10 px-4">
                                <p class="text-xs text-slate-400 uppercase tracking-widest font-semibold">Sem registos</p>
                            </div>
                        ` : conversations.map((conv) => `
                            <div onclick="loadConversation('${conv.id}')" class="group relative p-3 mb-1 rounded-xl cursor-pointer transition-all ${viewingHistoryId === conv.id ? "bg-orange-50 text-orange-700" : "hover:bg-slate-50 text-slate-600"}">
                                <p class="text-sm font-medium truncate pr-6">${conv.title}</p>
                                <p class="text-[10px] opacity-60 mt-0.5">${new Date(conv.lastUpdate).toLocaleDateString()}</p>
                                <button onclick="event.stopPropagation(); deleteConversation('${conv.id}')" class="absolute right-2 top-4 opacity-0 group-hover:opacity-100 p-1 hover:text-red-500 transition-all">üóëÔ∏è</button>
                            </div>
                        `).join("")}
                    </div>
                </div>

                <div class="flex-1 flex flex-col min-w-0 bg-white md:bg-[#F8FAFC]">
                    <nav class="h-16 border-b border-slate-200 bg-white flex items-center px-6 justify-between shrink-0">
                        <div class="flex items-center gap-4">
                            <button onclick="toggleSidebar()" class="p-2 -ml-2 hover:bg-slate-100 rounded-lg transition-colors">
                                <span class="text-xl">‚ò∞</span>
                            </button>
                            <div>
                                <h1 class="font-bold text-slate-900">ChefBot</h1>
                                <div class="flex items-center gap-1.5">
                                    <div class="w-1.5 h-1.5 bg-emerald-500 rounded-full"></div>
                                    <span class="text-[10px] uppercase tracking-wider font-bold text-slate-400">Sistema Ativo</span>
                                </div>
                            </div>
                        </div>
                    </nav>

                    <div class="flex-1 overflow-y-auto custom-scrollbar" id="messagesArea">
                        <div class="max-w-3xl mx-auto py-10 px-6">
                            ${messages.length === 1 && !isViewingHistory ? `
                                <div class="mb-12 text-center animate-fadeIn pt-10">
                                    <h2 class="text-4xl font-extrabold text-slate-900 mb-4 tracking-tight">O que vamos preparar hoje?</h2>
                                    <p class="text-slate-500 text-base mb-10 max-w-md mx-auto">Escolha um atalho ou descreva os ingredientes que tem √† m√£o para come√ßarmos.</p>
                                    <div class="flex flex-wrap gap-3 justify-center">
                                        ${quickActions.map(a => `
                                            <button onclick="sendMessage('${a.text}')" class="flex items-center gap-2 px-6 py-3 ${a.color} border rounded-xl shadow-sm hover:shadow-md hover:border-orange-200 transition-all text-sm font-semibold">
                                                <span>${a.icon}</span> ${a.text}
                                            </button>
                                        `).join("")}
                                    </div>
                                </div>
                            ` : ""}

                            ${messages.map((m, i) => renderMessage(m, i)).join("")}
                            ${isTyping ? `
                                <div class="flex gap-4 mb-8 animate-fadeIn">
                                    <div class="w-8 h-8 rounded-lg bg-orange-100 flex items-center justify-center text-sm">üë®‚Äçüç≥</div>
                                    <div class="bg-slate-100 px-4 py-3 rounded-2xl rounded-tl-none flex gap-1 items-center">
                                        <div class="w-1.5 h-1.5 bg-slate-400 rounded-full animate-bounce"></div>
                                        <div class="w-1.5 h-1.5 bg-slate-400 rounded-full animate-bounce [animation-delay:0.2s]"></div>
                                        <div class="w-1.5 h-1.5 bg-slate-400 rounded-full animate-bounce [animation-delay:0.4s]"></div>
                                    </div>
                                </div>
                            ` : ""}
                        </div>
                    </div>

                    <div class="p-6 shrink-0">
                        <div class="max-w-3xl mx-auto relative">
                            ${isViewingHistory ? `
                                <div class="bg-slate-100 text-slate-500 py-3 px-6 rounded-2xl text-center text-sm font-medium border border-slate-200">
                                    Modo de visualiza√ß√£o de hist√≥rico
                                </div>
                            ` : `
                                <input id="messageInput" value="${input}" type="text" placeholder="Pergunte sobre uma receita ou ingrediente..." 
                                    class="w-full bg-white border border-slate-200 rounded-2xl py-4 pl-6 pr-16 shadow-xl focus:outline-none focus:ring-2 focus:ring-orange-500/20 focus:border-orange-500 transition-all">
                                <button onclick="sendMessageFromInput()" class="absolute right-3 top-3 bg-orange-600 hover:bg-orange-700 text-white p-2.5 rounded-xl transition-all shadow-lg shadow-orange-200">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"/></svg>
                                </button>
                            `}
                        </div>
                    </div>
                </div>
            `;

        setTimeout(() => {
          const area = document.getElementById("messagesArea");
          if (area) area.scrollTop = area.scrollHeight;
          const inputEl = document.getElementById("messageInput");
          if (inputEl) {
            inputEl.addEventListener("input", (e) => input = e.target.value);
            inputEl.addEventListener("keypress", (e) => e.key === "Enter" && sendMessageFromInput());
            inputEl.focus();
          }
        }, 0);
      }

      function renderMessage(message, index) {
        const isBot = message.type === "bot";
        const isViewingHistory = viewingHistoryId !== null;

        return `
            <div class="flex ${isBot ? "justify-start" : "justify-end"} mb-8 animate-fadeIn">
                <div class="flex ${isBot ? "flex-row" : "flex-row-reverse"} gap-4 max-w-[85%]">
                    <div class="w-8 h-8 shrink-0 rounded-lg flex items-center justify-center text-sm shadow-sm ${isBot ? "bg-orange-600 text-white" : "bg-slate-800 text-white"}">
                        ${isBot ? "üë®‚Äçüç≥" : "U"}
                    </div>
                    <div class="flex flex-col ${isBot ? "items-start" : "items-end"}">
                        <div class="px-5 py-3 rounded-2xl shadow-sm border ${isBot ? "bg-white border-slate-100 text-slate-700 rounded-tl-none" : "bg-slate-800 text-white rounded-tr-none"}">
                            <div class="text-[15px] leading-relaxed whitespace-pre-wrap">${formatText(message.text)}</div>
                        </div>
                        
                        ${message.buttons && message.buttons.length > 0 && !isViewingHistory ? `
                            <div class="flex flex-wrap gap-2 mt-4">
                                ${message.buttons.map(btn => `
                                    <button onclick="handleButtonClick(decodeURIComponent('${encodeURIComponent(btn.payload)}'))" 
                                        class="px-4 py-1.5 bg-white border border-orange-200 text-orange-600 rounded-full hover:bg-orange-600 hover:text-white transition-all text-xs font-semibold shadow-sm">
                                        ${btn.title}
                                    </button>
                                `).join("")}
                            </div>
                        ` : ""}
                        <span class="text-[10px] text-slate-400 mt-2 font-medium uppercase tracking-tighter">
                            ${message.timestamp.toLocaleTimeString("pt-PT", { hour: "2-digit", minute: "2-digit" })}
                        </span>
                    </div>
                </div>
            </div>
        `;
      }

      function formatText(text) {
        let processedText = text.replace(/!\[(.*?)\]\((.*?)\)/g, (match, alt, url) => {
          if (url.startsWith('http')) {
            return `<div class="my-4 rounded-xl overflow-hidden border border-slate-100 shadow-sm"><img src="${url}" alt="${alt}" class="w-full object-cover max-h-72" onerror="this.src='https://via.placeholder.com/400x300?text=Sem+Imagem'"></div>`;
          }
          return '';
        });
        return processedText.replace(/\*\*(.*?)\*\*/g, '<strong class="font-bold text-slate-900">$1</strong>');
      }

      async function sendMessage(text) {
        if (!text.trim() || viewingHistoryId) return;
        messages.push({ type: "user", text: text, timestamp: new Date() });
        input = "";
        isTyping = true;
        render();

        try {
          const response = await fetch(RASA_URL, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ sender: "user", message: text }),
          });
          const data = await response.json();
          isTyping = false;
          if (data && data.length > 0) {
            data.forEach((msg) => {
              messages.push({ type: "bot", text: msg.text, buttons: msg.buttons, timestamp: new Date() });
            });
          }
          saveCurrentConversation();
          render();
        } catch (error) {
          isTyping = false;
          messages.push({ type: "bot", text: "‚ùå Erro de conex√£o com o servidor Rasa.", timestamp: new Date() });
          render();
        }
      }

      function sendMessageFromInput() {
        if (input.trim()) sendMessage(input.trim());
      }

      function handleButtonClick(payload) {
        sendMessage(payload);
      }

      loadConversations();
      createNewConversation();
    </script>
  </body>
</html>